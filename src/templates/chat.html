{% extends "base.html" %}

{% block title %}AI ë§›ì§‘ ì¶”ì²œ - FOODI{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #f5f5f5;
    }

    .chat-container {
        max-width: 900px;
        margin: 20px auto;
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .chat-title {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .ai-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        backdrop-filter: blur(10px);
    }

    .chat-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        background: #4ade80;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        background: linear-gradient(to bottom, #fafafa 0%, #ffffff 100%);
    }

    .message {
        margin-bottom: 25px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .message.bot .message-avatar {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
    }

    .message.user .message-avatar {
        background: linear-gradient(45deg, #4ade80, #06b6d4);
        color: white;
    }

    .message-content {
        max-width: 70%;
        min-width: 200px;
    }

    .message-bubble {
        padding: 18px 22px;
        border-radius: 20px;
        line-height: 1.6;
        position: relative;
        word-wrap: break-word;
    }

    .message.bot .message-bubble {
        background: white;
        border: 2px solid #f1f3f4;
        color: #333;
        border-radius: 20px 20px 20px 5px;
    }

    .message.user .message-bubble {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 20px 20px 5px 20px;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 8px;
        text-align: center;
    }

    .typing-indicator {
        display: none;
        padding: 20px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }

    .typing-dots {
        display: inline-flex;
        gap: 4px;
        margin-left: 8px;
    }

    .typing-dot {
        width: 6px;
        height: 6px;
        background: #6c757d;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    .chat-input-area {
        background: white;
        padding: 25px 30px;
        border-top: 1px solid #e5e7eb;
    }

    .input-container {
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }

    .message-input {
        flex: 1;
        border: 2px solid #e5e7eb;
        border-radius: 25px;
        padding: 15px 20px;
        font-size: 1rem;
        resize: none;
        max-height: 120px;
        min-height: 50px;
        transition: all 0.3s ease;
        background: #fafafa;
    }

    .message-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .send-button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        cursor: pointer;
        flex-shrink: 0;
    }

    .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .quick-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .quick-action {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 0.85rem;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .quick-action:hover {
        border-color: #667eea;
        color: #667eea;
        background: #f8faff;
    }

    .chat-tips {
        background: #f8faff;
        border: 1px solid #e0e7ff;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .recommendation-card {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
    }

    .restaurant-info {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .restaurant-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .btn-action {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-action:hover {
        background: rgba(255,255,255,0.3);
        color: white;
        text-decoration: none;
    }

    .btn-action:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .info-unavailable {
        color: rgba(255,255,255,0.7);
        font-style: italic;
    }

    @media (max-width: 768px) {
        .chat-container {
            margin: 10px;
            height: calc(100vh - 20px);
            border-radius: 15px;
        }
        
        .chat-header {
            padding: 20px;
        }
        
        .chat-messages {
            padding: 20px;
        }
        
        .chat-input-area {
            padding: 20px;
        }
        
        .message-content {
            max-width: 85%;
            min-width: 150px;
        }
        
        .input-container {
            gap: 10px;
        }
        
        .send-button {
            width: 45px;
            height: 45px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-title">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h4 class="mb-1">FOODI AI ë§›ì§‘ ì¶”ì²œ</h4>
                    <div class="chat-status">
                        <div class="status-indicator"></div>
                        <span>ì˜¨ë¼ì¸ Â· ì¦‰ì‹œ ì‘ë‹µ</span>
                    </div>
                </div>
            </div>
            <div>
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home me-2"></i>í™ˆìœ¼ë¡œ
                </a>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Message -->
            <div class="message bot">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹ FOODI AIì…ë‹ˆë‹¤.<br><br>
                        {% if chat_data.openai_enabled %}
                            ì €ëŠ” <strong>{{ chat_data.model_name }}</strong> ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ëŒ€êµ¬ ë‹¬ì„œêµ¬ì˜ ë§›ì§‘ì„ ì •í™•í•˜ê³  ê°œì¸í™”ëœ ë°©ì‹ìœ¼ë¡œ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤! ğŸ¤–
                        {% else %}
                            í˜„ì¬ ê¸°ë³¸ ì¶”ì²œ ì‹œìŠ¤í…œìœ¼ë¡œ ìš´ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤. ê³§ ë” ë‚˜ì€ AI ì„œë¹„ìŠ¤ë¡œ ì—…ê·¸ë ˆì´ë“œë  ì˜ˆì •ì…ë‹ˆë‹¤! ğŸ”§
                        {% endif %}
                        <br><br>
                        <strong>ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</strong>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li>íŠ¹ì • ìŒì‹ ì¢…ë¥˜ë‚˜ ë¶„ìœ„ê¸°ì˜ ë§›ì§‘ ì¶”ì²œ</li>
                            <li>ì˜ˆì‚°ê³¼ ìœ„ì¹˜ë¥¼ ê³ ë ¤í•œ ë§›ì§‘ ì°¾ê¸°</li>
                            <li>íŠ¹ë³„í•œ ë‚ ì„ ìœ„í•œ ë ˆìŠ¤í† ë‘ ì¶”ì²œ</li>
                            <li>ë©”ë‰´ë‚˜ ë§›ì— ëŒ€í•œ ìƒì„¸ ì •ë³´</li>
                        </ul>
                        í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ˜Š
                    </div>
                    <div class="message-time">ë°©ê¸ˆ ì „</div>
                </div>
            </div>

            <!-- System Status (OpenAI ìƒíƒœ í‘œì‹œ) -->
            {% if chat_data.openai_enabled %}
                <div class="chat-tips" style="border-color: #28a745;">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>{{ chat_data.model_name }} AI í™œì„±í™”ë¨
                    </h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <small><strong>ì´ {{ chat_data.total_restaurants }}ê°œ</strong> ë§›ì§‘ ë°ì´í„°</small>
                        </div>
                        <div class="col-md-6 mb-2">
                            <small><strong>{{ chat_data.categories|length }}ê°œ</strong> ì¹´í…Œê³ ë¦¬ ì§€ì›</small>
                        </div>
                        <div class="col-md-6 mb-2">
                            <small><strong>ìì—°ì–´ ì²˜ë¦¬:</strong> ê³ ê¸‰ ì˜ë„ ë¶„ì„</small>
                        </div>
                        <div class="col-md-6 mb-2">
                            <small><strong>ê°œì¸í™”:</strong> ë§ì¶¤í˜• ì¶”ì²œ</small>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="chat-tips" style="border-color: #ffc107;">
                    <h6 class="text-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>ê¸°ë³¸ ì¶”ì²œ ì‹œìŠ¤í…œ ìš´ì˜ ì¤‘
                    </h6>
                    <p class="mb-0">
                        <small>
                            í˜„ì¬ ê¸°ë³¸ í‚¤ì›Œë“œ ë§¤ì¹­ ë°©ì‹ìœ¼ë¡œ ìš´ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤. 
                            OpenAI API í‚¤ë¥¼ ì„¤ì •í•˜ë©´ ë” ì •í™•í•œ AI ì¶”ì²œì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </small>
                    </p>
                </div>
            {% endif %}
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            AIê°€ ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-area">
            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action" onclick="sendQuickMessage('ê°€ì¡±ê³¼ í•¨ê»˜ ê°ˆ ìˆ˜ ìˆëŠ” í•œì‹ë‹¹ ì¶”ì²œí•´ì¤˜')">
                    <i class="fas fa-users"></i>ê°€ì¡± ëª¨ì„
                </div>
                <div class="quick-action" onclick="sendQuickMessage('ë¶„ìœ„ê¸° ì¢‹ì€ ë°ì´íŠ¸ ì½”ìŠ¤ ë§›ì§‘ ì¶”ì²œ')">
                    <i class="fas fa-heart"></i>ë°ì´íŠ¸ ì½”ìŠ¤
                </div>
                <div class="quick-action" onclick="sendQuickMessage('í˜¼ì ê°€ê¸° ì¢‹ì€ ê°€ì„±ë¹„ ë§›ì§‘')">
                    <i class="fas fa-user"></i>í˜¼ë°¥ ë§›ì§‘
                </div>
                <div class="quick-action" onclick="sendQuickMessage('ì ì‹¬ì‹œê°„ì— ë¹ ë¥´ê²Œ ë¨¹ì„ ìˆ˜ ìˆëŠ” ê³³')">
                    <i class="fas fa-clock"></i>ì ì‹¬ ì¶”ì²œ
                </div>
                <div class="quick-action" onclick="sendQuickMessage('ì•¼ì‹ìœ¼ë¡œ ì¢‹ì€ ë°°ë‹¬ ê°€ëŠ¥í•œ ê³³')">
                    <i class="fas fa-moon"></i>ì•¼ì‹/ë°°ë‹¬
                </div>
                <div class="quick-action" onclick="sendQuickMessage('íŠ¹ë³„í•œ ë‚  ê¸°ë…í•  ìˆ˜ ìˆëŠ” ê³ ê¸‰ ë ˆìŠ¤í† ë‘')">
                    <i class="fas fa-star"></i>íŠ¹ë³„í•œ ë‚ 
                </div>
                <div class="quick-action" onclick="sendQuickMessage('ì£¼ì°¨ ê°€ëŠ¥í•œ ë„“ì€ í•œì‹ë‹¹')">
                    <i class="fas fa-parking"></i>ì£¼ì°¨ ê°€ëŠ¥
                </div>
                <div class="quick-action" onclick="sendQuickMessage('ì„±ì„œë™ ê·¼ì²˜ ë§›ì§‘ ì¶”ì²œí•´ì¤˜')">
                    <i class="fas fa-map-marker-alt"></i>ì„±ì„œë™ ê·¼ì²˜
                </div>
            </div>

            <!-- Message Input -->
            <div class="input-container">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="ì–´ë–¤ ë§›ì§‘ì„ ì°¾ê³  ê³„ì‹ ê°€ìš”? ì˜ˆ: 'ê°€ì¡±ê³¼ í•¨ê»˜ ê°ˆ ìˆ˜ ìˆëŠ” í•œì‹ë‹¹ ì¶”ì²œí•´ì¤˜'" 
                    rows="1"></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const chatMessages = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        
        // Enable/disable send button
        sendButton.disabled = !this.value.trim();
    });

    // Send message on Enter (Shift+Enter for new line)
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Initial state
    sendButton.disabled = true;
});

// undefined ê°’ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function safeValue(value, defaultValue = 'ì •ë³´ ì—†ìŒ') {
    if (value === undefined || value === null || value === 'undefined' || value === 'null' || value === '') {
        return defaultValue;
    }
    return String(value).trim() || defaultValue;
}

function safeNumber(value, defaultValue = 0) {
    if (value === undefined || value === null || value === 'undefined' || value === 'null' || value === '') {
        return defaultValue;
    }
    const num = parseFloat(value);
    return isNaN(num) ? defaultValue : num;
}

function safeArray(value, defaultValue = []) {
    if (!Array.isArray(value)) {
        return defaultValue;
    }
    return value.filter(item => item && item !== 'undefined' && item !== 'null' && item !== '');
}

function formatPhoneNumber(phone) {
    const cleanPhone = safeValue(phone, '');
    if (cleanPhone === 'ì •ë³´ ì—†ìŒ' || cleanPhone === '') {
        return 'ì „í™”ë²ˆí˜¸ ì •ë³´ ì—†ìŒ';
    }
    
    // ìˆ«ìë§Œ ì¶”ì¶œ
    const digits = cleanPhone.replace(/\D/g, '');
    
    if (digits.length >= 10) {
        if (digits.startsWith('02')) {
            return `02-${digits.slice(2, 6)}-${digits.slice(6)}`;
        } else if (digits.length === 10) {
            return `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`;
        } else if (digits.length === 11) {
            return `${digits.slice(0, 3)}-${digits.slice(3, 7)}-${digits.slice(7)}`;
        }
    }
    
    return digits.length >= 8 ? cleanPhone : 'ì „í™”ë²ˆí˜¸ ì •ë³´ ì—†ìŒ';
}

function formatCategory(category) {
    const safeCategory = safeValue(category, 'ìŒì‹ì ');
    if (safeCategory === 'ì •ë³´ ì—†ìŒ') {
        return 'ìŒì‹ì ';
    }
    
    // '>' ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë§ˆì§€ë§‰ ìœ íš¨í•œ ì¹´í…Œê³ ë¦¬ ë°˜í™˜
    const parts = safeCategory.split(' > ').map(part => part.trim()).filter(part => part && part !== 'undefined');
    return parts.length > 0 ? parts[parts.length - 1] : 'ìŒì‹ì ';
}

function formatAddress(address) {
    const safeAddr = safeValue(address, 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ');
    if (safeAddr === 'ì •ë³´ ì—†ìŒ') {
        return 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
    }
    return safeAddr;
}

function formatRating(rating) {
    const safeRating = safeNumber(rating, 0);
    if (safeRating <= 0) {
        return { stars: 'â˜†â˜†â˜†â˜†â˜†', value: 'í‰ì  ì—†ìŒ' };
    }
    
    const fullStars = Math.floor(safeRating);
    const emptyStars = 5 - fullStars;
    const starsDisplay = 'â˜…'.repeat(fullStars) + 'â˜†'.repeat(emptyStars);
    
    return { 
        stars: starsDisplay, 
        value: safeRating.toFixed(1) 
    };
}

function addMessage(content, isUser = false, isRecommendation = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (isRecommendation) {
        messageDiv.innerHTML = `
            <div class="message-avatar">${isUser ? 'ë‚˜' : 'AI'}</div>
            <div class="message-content">
                ${content}
                <div class="message-time">${timeString}</div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar">${isUser ? 'ë‚˜' : 'AI'}</div>
            <div class="message-content">
                <div class="message-bubble">${content}</div>
                <div class="message-time">${timeString}</div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    
    // ì• ë‹ˆë©”ì´ì…˜
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(20px)';
    setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
    }, 100);
    
    scrollToBottom();
}

function addRecommendationCard(restaurant) {
    console.log(restaurant);
    // ì•ˆì „í•œ ë°ì´í„° ì²˜ë¦¬
    const name = safeValue(restaurant.name, 'ì´ë¦„ ì—†ìŒ');
    const category = formatCategory(restaurant.category);
    const location = safeValue(restaurant.location, 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ');
    const address = formatAddress(restaurant.address);
    const phone = formatPhoneNumber(restaurant.phone);
    const description = safeValue(restaurant.description, 'ë§›ì§‘ ì •ë³´ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
    const rating = formatRating(restaurant.rating);
    const reviewCount = safeNumber(restaurant.review_count, 0);
    const specialties = safeArray(restaurant.specialties);
    const restaurantId = safeValue(restaurant.id, 'unknown');
    
    // ì¶”ê°€ ì •ë³´ ì²˜ë¦¬ (ì¹´ì¹´ì˜¤ API ë°ì´í„°)
    const distance = safeValue(restaurant.distance_text || restaurant.distance, '');
    const formattedPhone = safeValue(restaurant.formatted_phone || phone, phone);
    const displayAddress = safeValue(restaurant.display_address || address, address);
    
    const recommendationHtml = `
        <div class="recommendation-card">
            <div class="restaurant-info">
                <div>
                    <h6 class="mb-1">${name}</h6>
                    <small>${category}${location !== 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ' ? ` Â· ${location}` : ''}</small>
                    <div class="mt-1">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <small>${displayAddress}</small>
                    </div>
                    ${distance && distance !== 'ì •ë³´ ì—†ìŒ' ? `
                        <div class="mt-1">
                            <i class="fas fa-route me-1"></i>
                            <small>${distance}</small>
                        </div>
                    ` : ''}
                </div>
                <div class="text-end">
                    <div class="text-warning mb-1">
                        ${rating.stars} ${rating.value}
                    </div>
                    ${reviewCount > 0 ? `<small class="text-white-50">${reviewCount}ê°œ ë¦¬ë·°</small>` : '<small class="text-white-50">ë¦¬ë·° ì •ë³´ ì—†ìŒ</small>'}
                </div>
            </div>
            <p class="mb-3">${description}</p>
            ${specialties.length > 0 ? `
                <div class="mb-3">
                    <small class="text-white-50">ì¶”ì²œ ë©”ë‰´: </small>
                    ${specialties.map(menu => `<span class="badge bg-light text-dark me-1">${menu}</span>`).join('')}
                </div>
            ` : ''}
            <div class="restaurant-actions">
                ${displayAddress !== 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ' ? `
                    <button class="btn-action" onclick="showOnMap('${displayAddress}')">
                        <i class="fas fa-map-marker-alt"></i>ìœ„ì¹˜ë³´ê¸°
                    </button>
                ` : `
                    <button class="btn-action" disabled title="ì£¼ì†Œ ì •ë³´ ì—†ìŒ">
                        <i class="fas fa-map-marker-alt"></i>ì£¼ì†Œ ì—†ìŒ
                    </button>
                `}
                <button class="btn-action" onclick="showOnMap('${displayAddress}')">
                    <i class="fas fa-map-marker-alt"></i>ìœ„ì¹˜ë³´ê¸°
                </button>
                <button class="btn-action" onclick="writeReview('${name}', '${displayAddress}')">
                    <i class="fas fa-clock"></i>ë¦¬ë·° ì‘ì„±
                </button>
            </div>
        </div>
    `;
    
    addMessage(recommendationHtml, false, true);
}

function showTyping() {
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.style.display = 'block';
    scrollToBottom();
}

function hideTyping() {
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.style.display = 'none';
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessage(message, true);
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    messageInput.value = '';
    messageInput.style.height = 'auto';
    document.getElementById('sendButton').disabled = true;
    
    // íƒ€ì´í•‘ í‘œì‹œ
    showTyping();
    
    // ì‹¤ì œ AI ì‘ë‹µ í˜¸ì¶œ
    generateAIResponse(message);
}

function sendQuickMessage(message) {
    const messageInput = document.getElementById('messageInput');
    messageInput.value = message;
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    document.getElementById('sendButton').disabled = false;
    messageInput.focus();
}

async function generateAIResponse(userMessage) {
    try {
        // API í˜¸ì¶œ
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: userMessage
            })
        });

        const data = await response.json();
        
        // íƒ€ì´í•‘ ìˆ¨ê¸°ê¸°
        hideTyping();

        if (data.success) {
            // AI ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ
            const aiResponse = safeValue(data.response, 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            addMessage(aiResponse);
            
            // ì¶”ì²œ ë§›ì§‘ë“¤ í‘œì‹œ (ìˆœì°¨ì ìœ¼ë¡œ)
            if (data.restaurants && Array.isArray(data.restaurants) && data.restaurants.length > 0) {
                setTimeout(() => {
                    data.restaurants.forEach((restaurant, index) => {
                        setTimeout(() => {
                            addRecommendationCard(restaurant);
                        }, index * 800);
                    });
                }, 1200);
                
                // í†µê³„ ì •ë³´ í‘œì‹œ (OpenAI ì‚¬ìš© ì‹œ)
                const poweredBy = safeValue(data.powered_by, '');
                if (poweredBy.includes('OpenAI')) {
                    setTimeout(() => {
                        const totalCandidates = safeNumber(data.total_candidates, 0);
                        const statsMessage = `
                            <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                <small class="text-muted">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    ${totalCandidates}ê°œ í›„ë³´ ì¤‘ì—ì„œ ${data.restaurants.length}ê°œë¥¼ ì—„ì„ í–ˆìŠµë‹ˆë‹¤<br>
                                    <i class="fas fa-robot me-2"></i>
                                    Powered by ${poweredBy}
                                </small>
                            </div>
                        `;
                        addMessage(statsMessage);
                    }, (data.restaurants.length * 800) + 1500);
                }
            }
            
            // ì¶”ê°€ ë„ì›€ë§
            setTimeout(() => {
                const helpMessage = data.restaurants && data.restaurants.length > 0 
                    ? 'ì¶”ì²œ ê²°ê³¼ê°€ ë§ˆìŒì— ë“œì‹œë‚˜ìš”? ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ë” ì°¾ì•„ë³´ê±°ë‚˜ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ˜Š'
                    : 'ë‹¤ë¥¸ ì¡°ê±´ì´ë‚˜ ì§€ì—­ìœ¼ë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì‹œê±°ë‚˜, êµ¬ì²´ì ì¸ ìš”êµ¬ì‚¬í•­ì„ ë§ì”€í•´ì£¼ì‹œë©´ ë” ì •í™•í•œ ì¶”ì²œì„ í•´ë“œë¦´ ìˆ˜ ìˆì–´ìš”! ğŸ”';
                
                addMessage(helpMessage);
            }, (data.restaurants?.length || 0) * 800 + 3000);
            
        } else {
            // ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
            const fallbackResponse = safeValue(data.fallback_response, '');
            const errorMessage = safeValue(data.error, 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            
            if (fallbackResponse) {
                addMessage(fallbackResponse);
            } else {
                addMessage(`ì£„ì†¡í•©ë‹ˆë‹¤. ${errorMessage} ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ”§`);
            }
            
            // ì˜¤ë¥˜ ì‹œ ë„ì›€ë§ ì œê³µ
            setTimeout(() => {
                addMessage('ë‹¤ìŒê³¼ ê°™ì´ ì§ˆë¬¸í•´ë³´ì„¸ìš”:<br>â€¢ "ê°€ì¡±ê³¼ í•¨ê»˜ ê°ˆ ìˆ˜ ìˆëŠ” í•œì‹ë‹¹"<br>â€¢ "ë°ì´íŠ¸í•˜ê¸° ì¢‹ì€ ë¶„ìœ„ê¸° ìˆëŠ” ì–‘ì‹ë‹¹"<br>â€¢ "ì„±ì„œë™ ê·¼ì²˜ ê°€ì„±ë¹„ ì¢‹ì€ ë§›ì§‘" ğŸ’¡');
            }, 2000);
        }
        
    } catch (error) {
        console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
        hideTyping();
        
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì²˜ë¦¬
        addMessage('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸŒ');
        
        setTimeout(() => {
            addMessage('ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ìƒˆë¡œê³ ì¹¨(F5)ì„ ì‹œë„í•´ë³´ì„¸ìš”. ğŸ“±');
        }, 2000);
    }
}

// ì•¡ì…˜ í•¨ìˆ˜ë“¤
function callRestaurant(phone, name) {
    const safePhone = safeValue(phone, '');
    const safeName = safeValue(name, 'ë§›ì§‘');
    
    if (safePhone !== 'ì •ë³´ ì—†ìŒ' && safePhone !== 'ì „í™”ë²ˆí˜¸ ì •ë³´ ì—†ìŒ' && safePhone !== '') {
        if (confirm(`${safeName}(${safePhone})ë¡œ ì „í™”ë¥¼ ê±¸ê¹Œìš”?`)) {
            window.location.href = `tel:${safePhone}`;
        }
    } else {
        showAlert('ì „í™”ë²ˆí˜¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    }
}

function writeReview(name, display_address) {
    console.log(name);
    const button = event?.target;
    if (button) {
        button.disabled = true;
        button.textContent = 'ì²˜ë¦¬ ì¤‘...';
    }

    setTimeout(() => {
        console.log("===========(03) ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œì‘");

        try {
            const reviewsUrl = `/reviews?restaurant_name=${encodeURIComponent(name)} &restaurant_address=${encodeURIComponent(display_address)} `;
            console.log(`ë¦¬ë‹¤ì´ë ‰íŠ¸ URL: ${reviewsUrl}`);
            window.location.href = reviewsUrl;
        } catch (error) {
            console.error('ë¦¬ë‹¤ì´ë ‰íŠ¸ ì˜¤ë¥˜:', error);
            addMessage(`ë¦¬ë·° í˜ì´ì§€ë¡œ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.`, false);
            setTimeout(() => {
                window.location.href = '/reviews';
            }, 2000);
        }
    }, 1000);
}


function showOnMap(address) {
    const safeAddress = safeValue(address, '');
    
    if (safeAddress !== 'ì •ë³´ ì—†ìŒ' && safeAddress !== 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ' && safeAddress !== '') {
        // ë„¤ì´ë²„ ì§€ë„ë¡œ ì´ë™
        const query = encodeURIComponent(safeAddress);
        const mapUrl = `https://map.naver.com/v5/search/${query}`;
        window.open(mapUrl, '_blank');
    } else {
        showAlert('ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    }
}

function getMoreInfo(restaurantId) {
    const safeId = safeValue(restaurantId, 'unknown');
    
    // ìƒì„¸ ì •ë³´ ìš”ì²­
    addMessage('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...', true);
    
    setTimeout(() => {
        addMessage(`ìƒì„¸ ì •ë³´ í˜ì´ì§€ ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ë” ìì„¸í•œ ì •ë³´ëŠ” ì „í™” ë¬¸ì˜ ë¶€íƒë“œë ¤ìš”! ğŸ“`);
    }, 1000);
}

function addToFavorites(restaurantId, restaurantName) {
    const safeId = safeValue(restaurantId, 'unknown');
    const safeName = safeValue(restaurantName, 'ë§›ì§‘');
    
    // ì°œí•˜ê¸° ê¸°ëŠ¥
    addMessage(`${safeName}ì„(ë¥¼) ì°œ ëª©ë¡ì— ì¶”ê°€í•˜ê³  ì‹¶ìœ¼ì‹œêµ°ìš”!`, true);
    
    setTimeout(() => {
        addMessage(`${safeName}ì´(ê°€) ì°œ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! â¤ï¸ ì°œ ëª©ë¡ì€ ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.`);
    }, 1000);
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (base.htmlì—ì„œ ì •ì˜ëœ ê²ƒë“¤ í™œìš©)
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${safeValue(message, 'ì•Œë¦¼')}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// ì´ˆê¸° ì• ë‹ˆë©”ì´ì…˜
window.addEventListener('load', function() {
    const messages = document.querySelectorAll('.message');
    messages.forEach((msg, index) => {
        msg.style.opacity = '0';
        msg.style.transform = 'translateY(20px)';
        setTimeout(() => {
            msg.style.transition = 'all 0.6s ease';
            msg.style.opacity = '1';
            msg.style.transform = 'translateY(0)';
        }, index * 200);
    });
});
</script>
{% endblock %}